<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kheerganga â€” Parvati Valley Explorer</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <canvas id="scene"></canvas>
  <div id="tooltip"></div>

  <script type="importmap">
  {
    "imports": {
      "three": "https://cdn.jsdelivr.net/npm/three@0.170.0/build/three.module.js",
      "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.170.0/examples/jsm/"
    }
  }
  </script>

  <script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
    import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
    import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
    import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
    import landscape from './landscape.js';

    async function main() {
      const theme = landscape;
      const defaults = theme.getSceneDefaults();

      const canvas = document.getElementById('scene');
      const renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
      renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.toneMapping = THREE.ACESFilmicToneMapping;
      renderer.toneMappingExposure = 1.0;

      const scene = new THREE.Scene();
      scene.background = new THREE.Color(defaults.background);

      const [cx, cy, cz] = defaults.cameraPos;
      const camera = new THREE.PerspectiveCamera(
        60, window.innerWidth / window.innerHeight,
        defaults.cameraNear || 0.5,
        defaults.cameraFar || 600,
      );
      camera.position.set(cx, cy, cz);

      const controls = new OrbitControls(camera, canvas);
      controls.enableDamping = true;
      controls.dampingFactor = 0.05;
      controls.minDistance = defaults.orbitMinDistance || 3;
      controls.maxDistance = defaults.orbitMaxDistance || 350;

      if (defaults.cameraTarget) {
        const [tx, ty, tz] = defaults.cameraTarget;
        controls.target.set(tx, ty, tz);
        camera.lookAt(tx, ty, tz);
      }

      const composer = new EffectComposer(renderer);
      composer.addPass(new RenderPass(scene, camera));
      composer.addPass(new UnrealBloomPass(
        new THREE.Vector2(window.innerWidth, window.innerHeight),
        defaults.bloomStrength, defaults.bloomRadius, defaults.bloomThreshold,
      ));

      // Environment (lighting, sky, clouds)
      theme.renderEnvironment(scene);

      // Terrain from real DEM
      await theme.generateTerrain(scene, camera, controls);

      window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
        composer.setSize(window.innerWidth, window.innerHeight);
      });

      function animate() {
        requestAnimationFrame(animate);
        controls.update();
        composer.render();
      }
      animate();
    }

    main().catch(console.error);
  </script>
</body>
</html>
